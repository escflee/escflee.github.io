# 数据链路层

# 成帧

## 字符计数法

Character Count，通过在每一帧后面添加该帧的长度来区分帧。缺点在于一旦出现差错，会造成严重后果。

## 字节/字符填充

Byte(Character)Stuffing，通过特殊的字符/比特串来标记每一帧的开始和结束。

## 透明传输

为防止数据部分中包含用于标记的控制字符/比特串造成冲突，可以采用以下方法：

- 添加标志符ESC，表示忽略后面的特殊符号：

  ![image-20220618193554270](media/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20220618193554270.png)

- 改变与控制字段类似的比特串：如若用于标志开始和结束的比特串为0111,1110，则当数据部分中出现连续的五个1时，在后面添加一个0。HDLC中使用。

## 物理层编码违例法

在物理层，利用并没有开放给使用者使用的特殊编码来标记帧的起始位置，使得标志字段和数据部分不会产生冲突。在Manchester编码中使用。

# 差错控制

## 海明距离

- Hamming Distance，指两个比特串之间相同位置，但数值不同的位数。对于编码而言，海明距离指编码中任意两个有效码字之间最小的海明距离。
- 检测t位错需要海明距离至少为t+1的编码方式。
- 纠正t位错需要海明距离至少为2t+1的编码方式。
- 要纠正一位错，假设数据部分有m位，校验部分有r位，则应满足$(m+r+1)2^m\le2^{m+r}$

## 海明码

- 2的幂次位，如第1、2、4、8位为校验位。
- 以二进制表示每一位的序号，如第11位可以表示为8+2+1。然后，该位要参与对应校验位的运算，如第11位要参与第1、2、8校验位的计算。
- 每个校验位采用偶校验，如对于一个长12位的比特串，第4位b4应该满足：b4⊕b5⊕b6⊕b7⊕b12=0
- 海明码的海明距离为3，因为任意一个数据位出错都至少造成三位的改变。可以检出2位错，纠出1位错。

![image-20220618235326632](media/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20220618235326632.png)

## CRC校验

CRC(Cyclic Redundancy Check)，循环冗余校验

- 多项式编码Polynomial Code：将比特串看作一个多项式，如：

  $110001=>x^5+x^4+x^0$

- 生成多项式：发送方和接收方提前约定的一个多项式，如：

  $G(x)=10011=x^4+x+x^0$，该多项式首位必须是1

- 在多项式算术中，全部按位分别运算，不考虑进位、借位。加减法全部由异或运算代替。

- 发送方编码：
  - 首先根据生成多项式的位数在要校验的比特串后添加0，如5位生成多项式则添加4个0
  - 然后用添加了0后的比特串除以生成多项式，得到余数
  - 最后将余数和被除数相加，得到最终要发送的串
- 接收方校验：
  - 用接收到的串除以生成多项式，余数为0表示校验正确

![image-20220619005355649](media/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20220619005355649.png)

![image-20220619005439769](media/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20220619005439769.png)

- 硬件实现：发送方和接收方均为从比特串的起始位置开始计算，一直计算到尾部。因此校验字段放在整个比特串的后部，从而不用储存任何字段，提高效率。

# 流量控制

## ARQ

ARQ(Automatic Repeat-reQuest)，自动重传请求，由以下机制构成：

- 序列号Sequence Number：用于标记帧的序号，防止帧发送过程中乱序、漏传或重传等问题。通常由固定位数的二进制数表示，并循环使用。

- 滑动窗口Sliding Window：发送窗口指发送方可以一次性发送并缓存等待ACK的帧的序号范围。接收窗口指接收方可以同时接收并缓存等待处理的帧的序号范围。接收发送窗口和接收窗口大小的和不应该超过序列号的总个数，否则在特殊情况下会出现错乱，如：序列号为$0～2^n-1$，发送窗口为$0～2^{n-1}-1$，接收窗口为$0～2^{n-1}$，发送窗口全部发送，接收窗口全部接收并移动到$2^{n-1}～0$，但发送的ACK丢失。此时当接收方接收到一个序号为0的帧，将无法区分该帧是旧的序号循环中的0号帧重传，还是新的序号循环中的0号帧。

- ACK：接收方成功接收到帧后向发送方发送接收到的帧的序列号，采用累计ACK(Cumulative ACK)的形式，如ACK序列号为n表示第n号帧及所有n号帧之前的帧都已成功接收到，这样可以减少ACK的发送次数。

  TCP中有所不同：ACK的序号n表示第n帧之前的所有帧都已接收，等待接收第n帧。同时TCP中还加入了选择性的确认的功能，可以在累积ACK的基础上单独确认其他已收到但并不连续的帧。

  发送方在发送每一帧后设置一个定时器，定时器时间内若没有接收到该帧的ACK则自动重传该帧。

- Piggybacking：捎带确认，为了提高信道使用效率，ACK尽量和数据帧一起发送，而不是发送一个单独的ACK帧。

- ACK Timer：和捎带确认一同使用，指当接收方有新的ACK需要发送后启动一个计时器，若计时器期限内没有新的数据要发送，则放弃捎带确认，发送单独的ACK帧。

- NAK：由于ACK的存在，NAK并不是必要的。NAK是接收方用来通知接收到的帧出错或接收到的帧乱序，促使其立刻重传出错帧的。为防止浪费，发送方会进行记录，确保某一帧因NAK而进行的重传只有一次。

## 实例

- 停止等待协议Stop-and-Wait：发送方和接收方的窗口大小都为1，捎带确认，超时重传。
- 回退N步协议Go-Back-N：在停止等待协议的基础上，发送方窗口大小改为大于1，接收方窗口大小为1，超时则从出错的帧开始全部重发。
- 选择重传协议Selective-Repeat：在回退N步协议的基础上，发送窗口和接收窗口大小均为$2^{n-1}$，序列号共$2^n$个。增加NAK和ACK Timer。出错时只重传出错帧。

## 性能

- 传输一帧数据所需的总时间：传输数据的时间$t_{tran}$+信号从发送方到接收方的时延$t_{prop}$+数据处理时间$t_{proc}$+传输ACK的时间$t_{ack}$+ACK的传输时延$t_{prop}$+ACK处理时间$t_{proc}$

- 计算过程中忽略处理时间$t_{proc}$，忽略单独ACK的传输时间$t_{ack}$，用$W$表示发送窗口大小，$1$表示一帧数据的传输时间，$a$表示传输时延，则信道利用率$U$为：

  $U=\frac{W}{1+2a}$，不考虑捎带确认

  $U=\frac{W}{2+2a}$，考虑捎带确认。

  若计算出的$U$大于1，则$U$取1。

# 实例

## HDLC

HDLC(High-Level Data Link Control)，高级数据链路控制

- 点到点，以比特为单位传输，提供可靠的面向连接服务
- 以01111110作为首尾标志，数据部分进行零比特填充
- CRC校验
- Go-Back-N、Selective-Repeat
- 硬件实现

## PPP

PPP(Point-to-Point Protocol)

- 点到点，以字节为单位传输，提供不进行ACK的面向无连接的服务
- 采用字节填充
- CRC校验
- 没有流量控制的机制
- 软件实现